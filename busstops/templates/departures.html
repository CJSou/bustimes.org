{% if when or departures %}
<div class="aside" id="departures">
    {% if when %}
    <form autocomplete="off">
        <input type="date" name="date" min="{{ today.isoformat }}" value="{{ when.date.isoformat }}" required>
        <input type="time" name="time" value="{{ when.time }}">
        <input type="submit" value="Go">
    </form>
    {% else %}<h2>Next departures</h2>{% endif %}
    {% for item in departures %}
        {% ifchanged item.time.date %}
            {% if forloop.first or item.time.date and item.time.date != today %}
                {% if not forloop.first %}
                    </tbody>
                    </table>
                {% endif %}
                {% if not forloop.first or item.time.date and item.time.date != today %}
                    <h3>{{ item.time|date:"l j F" }}</h3>
                {% endif %}
                <table>
                <tbody>
                    {% if indicator_prefix %}
                        <tr><td colspan="3"></td><th scope="col">{{ indicator_prefix }}</th></tr>
                    {% endif %}
            {% endif %}
        {% endifchanged %}
        <tr>
            <td{% if item.route.line_name and item.route.line_name|length <= 5 %} class="nowrap"{% endif %}>
            {% if item.service.id %}
                <a href="{{ item.service.get_absolute_url }}{% if item.date and item.date != today %}?date={{ item.date.isoformat }}{% endif %}">{% firstof item.route.line_name item.service.line_name item.service %}</a>
            {% elif item.service %}{{ item.service }}{% endif %}
            </td>
            <td>
                {{ item.destination }}
                {% if item.vehicle %}<div class="vehicle">{{ item.vehicle }}</div>{% endif %}
            </td>
            <td>{% if item.link %}<a href="{{ item.link }}">{% endif %}
                {% if item.cancelled %}
                    <del>{{ item.time.time }}</del>
                {% elif item.live %}
                    {{ item.live.time }}⚡&#xfe0f;
                {% else %}
                    {% firstof item.time.time item.time %}
                {% endif %}{% if item.link %}</a>{% endif %}
            </td>
            {% if object is stoparea %}
                <td>{{ item.stop_time.stop.get_icon|default:"" }}</td>
            {% endif %}
        </tr>
        {% if forloop.last %}
            </tbody>
            </table>
        {% endif %}
    {% endfor %}

    {% if when %}
        {% if next_page %}
            <p class="next"><a href="{{ next_page }}">Later &darr;</a></p>
        {% endif %}
        {% if when != now %}
            <p><a href="{{ object.get_absolute_url }}">&uarr; Now</a></p>
        {% endif %}
    {% endif %}

    {% if live %}
        <p class="credit">⚡&#xfe0f; denotes ‘live’ times guessed (sometimes badly) from buses’ actual locations</p>
    {% endif %}
</div>
{% endif %}
