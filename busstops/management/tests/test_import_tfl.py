from django.conf import settings
from django.core.management import call_command
from django.test import TestCase
from vcr import use_cassette

from ...models import DataSource, Region, Service, StopPoint


class ImportTfLTest(TestCase):
    @classmethod
    def setUpTestData(cls):
        region = Region.objects.create(id="L", name="London")
        source = DataSource.objects.create(name="L")
        cls.service_1 = Service.objects.create(
            line_name="1", region=region, source=source, current=True
        )
        cls.service_111 = Service.objects.create(
            line_name="111", region=region, source=source, current=True
        )
        StopPoint.objects.bulk_create(
            [
                StopPoint(atco_code="490004733C", active=True),
                StopPoint(active=True, atco_code="490011723E"),
                StopPoint(active=True, atco_code="490013042J"),
                StopPoint(active=True, atco_code="490000229L"),
                StopPoint(active=True, atco_code="490011722Q"),
                StopPoint(active=True, atco_code="490005603W"),
                StopPoint(active=True, atco_code="490011719A"),
                StopPoint(active=True, atco_code="490009482N"),
                StopPoint(active=True, atco_code="490003311N"),
                StopPoint(active=True, atco_code="490012353W"),
                StopPoint(active=True, atco_code="490011538W"),
                StopPoint(active=True, atco_code="490003275W"),
                StopPoint(active=True, atco_code="490012367W"),
                StopPoint(active=True, atco_code="490007362S"),
                StopPoint(active=True, atco_code="490015272BJ"),
                StopPoint(active=True, atco_code="490003658BS"),
                StopPoint(active=True, atco_code="490011632BT"),
                StopPoint(active=True, atco_code="490000073N"),
                StopPoint(active=True, atco_code="490009281A"),
                StopPoint(active=True, atco_code="490012693N1"),
                StopPoint(active=True, atco_code="490013485N"),
                StopPoint(active=True, atco_code="490000254K"),
                StopPoint(active=True, atco_code="490014270P"),
                StopPoint(active=True, atco_code="490008932T"),
                StopPoint(active=True, atco_code="490003191F"),
                StopPoint(active=True, atco_code="490000112P"),
                StopPoint(active=True, atco_code="490006203RA"),
                StopPoint(active=True, atco_code="490000235N"),
                StopPoint(active=True, atco_code="490000235Z"),
                StopPoint(active=True, atco_code="490000112M"),
                StopPoint(active=True, atco_code="490019703Z"),
                StopPoint(active=True, atco_code="490014271N"),
                StopPoint(active=True, atco_code="490000254E"),
                StopPoint(active=True, atco_code="490013485S1"),
                StopPoint(active=True, atco_code="490012693S2"),
                StopPoint(active=True, atco_code="490009281E"),
                StopPoint(active=True, atco_code="490000073K"),
                StopPoint(active=True, atco_code="490011632BA"),
                StopPoint(active=True, atco_code="490003658BC"),
                StopPoint(active=True, atco_code="490004315BH"),
                StopPoint(active=True, atco_code="490007533E"),
                StopPoint(active=True, atco_code="490006792E"),
                StopPoint(active=True, atco_code="490012367E"),
                StopPoint(active=True, atco_code="490003275E"),
                StopPoint(active=True, atco_code="490003533E"),
                StopPoint(active=True, atco_code="490012353E"),
                StopPoint(active=True, atco_code="490003311E"),
                StopPoint(active=True, atco_code="490009482S"),
                StopPoint(active=True, atco_code="490007086B"),
                StopPoint(active=True, atco_code="490003716E"),
                StopPoint(active=True, atco_code="490005603E"),
                StopPoint(active=True, atco_code="490014228E"),
                StopPoint(active=True, atco_code="490000229O"),
                StopPoint(active=True, atco_code="490011723P"),
                StopPoint(active=True, atco_code="490004733D"),
                StopPoint(active=True, atco_code="490005800A7"),
                StopPoint(active=True, atco_code="490001173R"),
                StopPoint(active=True, atco_code="490003909P2"),
                StopPoint(active=True, atco_code="490007741D"),
                StopPoint(active=True, atco_code="490010777W"),
                StopPoint(active=True, atco_code="490007727B"),
                StopPoint(active=True, atco_code="490007713E"),
                StopPoint(active=True, atco_code="490007734W"),
                StopPoint(active=True, atco_code="490013570W"),
                StopPoint(active=True, atco_code="490007125W"),
                StopPoint(active=True, atco_code="490007724W"),
                StopPoint(active=True, atco_code="490007735W"),
                StopPoint(active=True, atco_code="490001132B"),
                StopPoint(active=True, atco_code="490011238N"),
                StopPoint(active=True, atco_code="490008299N"),
                StopPoint(active=True, atco_code="490005665N"),
                StopPoint(active=True, atco_code="490010460N"),
                StopPoint(active=True, atco_code="490003064E1"),
                StopPoint(active=True, atco_code="490011472W"),
                StopPoint(active=True, atco_code="490007113W"),
                StopPoint(active=True, atco_code="490007115N"),
                StopPoint(active=True, atco_code="490013228N"),
                StopPoint(active=True, atco_code="490013103W"),
                StopPoint(active=True, atco_code="490003717W"),
                StopPoint(active=True, atco_code="490013110N"),
                StopPoint(active=True, atco_code="490003718N"),
                StopPoint(active=True, atco_code="490010807N"),
                StopPoint(active=True, atco_code="490013970N1"),
                StopPoint(active=True, atco_code="490009221N"),
                StopPoint(active=True, atco_code="490011940E"),
                StopPoint(active=True, atco_code="490006485N"),
                StopPoint(active=True, atco_code="490007767N"),
                StopPoint(active=True, atco_code="490012168N"),
                StopPoint(active=True, atco_code="490010173N"),
                StopPoint(active=True, atco_code="490005798W"),
                StopPoint(active=True, atco_code="490008126EB"),
                StopPoint(active=True, atco_code="490003854E"),
                StopPoint(active=True, atco_code="490007573J"),
                StopPoint(active=True, atco_code="490013777O"),
                StopPoint(active=True, atco_code="490008399K"),
                StopPoint(active=True, atco_code="490015241C"),
                StopPoint(active=True, atco_code="490000117E"),
                StopPoint(active=True, atco_code="490006028N"),
                StopPoint(active=True, atco_code="490007428N"),
                StopPoint(active=True, atco_code="490007427N"),
                StopPoint(active=True, atco_code="490008272W"),
                StopPoint(active=True, atco_code="490012443N"),
                StopPoint(active=True, atco_code="490010221W"),
                StopPoint(active=True, atco_code="490005705S"),
                StopPoint(active=True, atco_code="490008114W"),
                StopPoint(active=True, atco_code="490012229W"),
                StopPoint(active=True, atco_code="490010365W"),
                StopPoint(active=True, atco_code="490008115W"),
                StopPoint(active=True, atco_code="490012243W"),
                StopPoint(active=True, atco_code="490005706N"),
                StopPoint(active=True, atco_code="490013494S"),
                StopPoint(active=True, atco_code="490013235S"),
                StopPoint(active=True, atco_code="490005704W"),
                StopPoint(active=True, atco_code="490013596W"),
                StopPoint(active=True, atco_code="490010677W1"),
                StopPoint(active=True, atco_code="490007811D"),
                StopPoint(active=True, atco_code="490004149W"),
                StopPoint(active=True, atco_code="490012176W"),
                StopPoint(active=True, atco_code="490008016S"),
                StopPoint(active=True, atco_code="490013235N"),
                StopPoint(active=True, atco_code="4900801619"),
                StopPoint(active=True, atco_code="490010245N"),
                StopPoint(active=True, atco_code="490012177E"),
                StopPoint(active=True, atco_code="490012176E"),
                StopPoint(active=True, atco_code="490004139E"),
                StopPoint(active=True, atco_code="490010251G"),
                StopPoint(active=True, atco_code="490007811C"),
                StopPoint(active=True, atco_code="490015397E"),
                StopPoint(active=True, atco_code="490010677W2"),
                StopPoint(active=True, atco_code="490013596E"),
                StopPoint(active=True, atco_code="490005704E"),
                StopPoint(active=True, atco_code="490013494N"),
                StopPoint(active=True, atco_code="490012243E"),
                StopPoint(active=True, atco_code="490008115E"),
                StopPoint(active=True, atco_code="490010365E"),
                StopPoint(active=True, atco_code="490012229E"),
                StopPoint(active=True, atco_code="490008114E"),
                StopPoint(active=True, atco_code="490010221E"),
                StopPoint(active=True, atco_code="490012443S"),
                StopPoint(active=True, atco_code="490008272E"),
                StopPoint(active=True, atco_code="490007427S"),
                StopPoint(active=True, atco_code="490012406S"),
                StopPoint(active=True, atco_code="490000117D"),
                StopPoint(active=True, atco_code="490015241S"),
                StopPoint(active=True, atco_code="490007766M"),
                StopPoint(active=True, atco_code="490007573N"),
                StopPoint(active=True, atco_code="490008126E"),
                StopPoint(active=True, atco_code="490005798S"),
                StopPoint(active=True, atco_code="490010173S"),
                StopPoint(active=True, atco_code="490012168S"),
                StopPoint(active=True, atco_code="490007767S"),
                StopPoint(active=True, atco_code="490006485S"),
                StopPoint(active=True, atco_code="490011940S"),
                StopPoint(active=True, atco_code="490013970N2"),
                StopPoint(active=True, atco_code="490010807S"),
                StopPoint(active=True, atco_code="490003718S"),
                StopPoint(active=True, atco_code="490012703S"),
                StopPoint(active=True, atco_code="490013110S"),
                StopPoint(active=True, atco_code="490013103E"),
                StopPoint(active=True, atco_code="490013228E"),
                StopPoint(active=True, atco_code="490007115S"),
                StopPoint(active=True, atco_code="490011472E"),
                StopPoint(active=True, atco_code="490010275S"),
                StopPoint(active=True, atco_code="490003064W"),
                StopPoint(active=True, atco_code="490010460S"),
                StopPoint(active=True, atco_code="490005665S"),
                StopPoint(active=True, atco_code="490008299S"),
                StopPoint(active=True, atco_code="490011238S"),
                StopPoint(active=True, atco_code="490001132A"),
                StopPoint(active=True, atco_code="490007735E"),
                StopPoint(active=True, atco_code="490003224E"),
                StopPoint(active=True, atco_code="490007125E"),
                StopPoint(active=True, atco_code="490012423E"),
                StopPoint(active=True, atco_code="490013570E"),
                StopPoint(active=True, atco_code="490007734E"),
                StopPoint(active=True, atco_code="490007713D"),
                StopPoint(active=True, atco_code="490007729C"),
                StopPoint(active=True, atco_code="490007727A"),
                StopPoint(active=True, atco_code="490010777E"),
                StopPoint(active=True, atco_code="490010714E"),
                StopPoint(active=True, atco_code="490007741C"),
                StopPoint(active=True, atco_code="490003909N"),
                StopPoint(active=True, atco_code="490005800A2"),
            ]
        )

    def test_import_tfl(self):
        self.assertEqual(list(self.service_1.get_traveline_links()), [])

        with use_cassette(
            str(settings.BASE_DIR / "fixtures" / "vcr" / "import_tfl.yaml"),
            decode_compressed_response=True,
        ):
            call_command("import_tfl")

        self.assertEqual(
            list(self.service_1.get_traveline_links()),
            [
                (
                    "https://tfl.gov.uk/bus/timetable/1/",
                    "Timetable on the Transport for London website",
                )
            ],
        )
