{% extends 'page.html' %}

{% block title %}Vehicle edits ‚Äì bustimes.org{% endblock %}

{% block head %}
    <link rel="stylesheet" href="/liveries.{{ liveries_css_version }}.css">
{% endblock %}

{% block bodyclass %}{% endblock %}

{% block content %}


<ul class="tabs">
    <li><a href="/vehicles/history">Recent changes</a></li>
    <li>Pending vehicle edits</li>
</ul>

<h1>Pending vehicle edits</h1>

<div class="sidebar">
    <form>
        {{ filter.form.as_p }}

        <p><input type="submit" value="Search"></p>
    </form>
</div>

<div class="table-wrapper">
    <table class="fleet">
        <thead>
            <tr>
                <th scope="col">date</th>
                <th scope="col">user</th>
                <th scope="col">vehicle</th>
                <th scope="col"><a href="?{{ toggle_order.vehicle }}">*</a></th>
                <th scope="col"></th>
                <th scope="col">proposed changes</th>
                <th scope="col"><a href="?{{ toggle_order.score }}">score</a></th>
            </tr>
        </thead>
        <tbody>
            {% for edit in edits %}
                <tr>
                    <td>{{ edit.datetime }}</td>
                    <td><a href="?user={{ edit.user_id }}">{{ edit.user }}</a></td>
                    <td><a href="{{ edit.vehicle.get_absolute_url }}">{{ edit.vehicle }}</a></td>
                    <td>{{ edit.edit_count }}</td>
                    <td><div class="livery{% if edit.vehicle.livery_id %} livery-{{ edit.vehicle.livery_id }}{% else %}" style="background:{{ edit.vehicle.get_livery }}{% endif %}"></div></td>
                    <td>{% for key, value in edit.get_changes.items %}
                        {% if key == 'features' %}
                            {% for feature in value %}{{ feature|safe }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        {% elif key == 'colours' %}
                            colours: <div class="livery" style="background:{{ edit.get_css }}"></div>
                        {% elif key == 'livery_id' %}
                            livery:
                            {% if edit.vehicle.livery %}{{ edit.vehicle.livery.name }} to {% endif %}
                            <div class="livery livery-{{ value }}"></div> {{ edit.livery.name }}
                        {% elif key == 'notes' and value == 'Duplicate' %}
                            <a href="/admin/vehicles/vehicle/?q={{ edit.vehicle.reg }}">Duplicate</a>
                        {% else %}{{ key }}: {{ value }}
                        {% endif %}
                        <br>{% endfor %}
                        {% if edit.url %}{{ edit.url|urlize }}{% endif %}
                    </td>
                    <td class="score">{{ edit.score }}</td>
                    {% if user.is_staff %}
                        <td><a class="action" href="/vehicles/edits/{{ edit.id }}/apply" style="background:#0f0">üëç apply</a></td>
                        <td><a class="action" href="/vehicles/edits/{{ edit.id }}/approve">approve</a></td>
                        <td><a class="action" href="/vehicles/edits/{{ edit.id }}/disapprove" style="color:#fff;background:#f00">üëé disapprove</a></td>
                    {% else %}
                        <td><a class="action" href="/vehicles/edits/{{ edit.id }}/vote/up">üëç</a></td>
                        <td><a class="action" href="/vehicles/edits/{{ edit.id }}/vote/down">üëé</a></td>
                    {% endif %}
                    <td>{{ edit.vehicle.get_flickr_link }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if edits.has_other_pages %}
    <nav>
        <ul class="horizontal">
            {% if edits.has_previous %}
                <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}">1</a></li>
                {% if edits.previous_page_number > 1 %}
                    {% if edits.previous_page_number > 2 %}
                        <li>&hellip;</li>
                    {% endif %}
                    <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}page={{ edits.previous_page_number }}">{{ edits.previous_page_number }}</a></li>
                {% endif %}
            {% endif %}

            <li>{{ edits.number }}</li>

            {% if edits.has_next %}
                {% if edits.next_page_number < edits.paginator.num_pages %}
                    <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}page={{ edits.next_page_number }}">{{ edits.next_page_number }}</a></li>
                    <li>&hellip;</li>
                {% endif %}
                <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}page={{ edits.paginator.num_pages }}">{{ edits.paginator.num_pages }}</a></li>
            {% endif %}
        </ul>
    </nav>
{% endif %}

{% endblock %}

{% block ad %}{% endblock %}

{% block foot %}

<script>

(function () {
    'use strict';

    for (const button of document.querySelectorAll('a.action')) {
        let row = button.parentElement.parentElement;
        button.onclick = function(event) {
            let url = this.href;
            fetch(this.href, {
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    button.style.opacity = '.5';
                    response.text().then(text => {
                        if (text) {
                            row.querySelector('.score').innerText = text;
                        }
                    });
                    if (url.endsWith('/up')) {
                        button.style.transition = 'transform .5s';
                        button.style.transform = 'translateY(-2em)';
                    } else if (url.endsWith('/down')) {
                        button.style.transition = 'transform .5s';
                        button.style.transform = 'translateY(2em)';
                    }
                }
            });
            return false;
        };
    }
})();
</script>

{% endblock %}
