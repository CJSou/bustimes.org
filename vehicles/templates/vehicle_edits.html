{% extends 'page.html' %}

{% block title %}Vehicle edits ‚Äì bustimes.org{% endblock %}

{% block head %}
    <link rel="stylesheet" href="/liveries.{{ liveries_css_version }}.css">
{% endblock %}

{% block bodyclass %}{% endblock %}

{% block content %}

<style>
    td button {
        border: 0;
        border-radius: 0;
        display: block;
        margin: -.25em -.5em;
        padding: .25em .5em;
        position: static;
        cursor: pointer;
    }
</style>

<ul class="tabs">
    <li><a href="/vehicles/history">Recent changes</a></li>
    <li>Pending vehicle edits</li>
</ul>

<h1>Pending vehicle edits</h1>

<div class="sidebar">
    <form>
        {{ filter.form.as_p }}

        <p><input type="submit" value="Search"></p>
    </form>
</div>

{% if user.is_staff %}
    <form id="edits" method="POST">

    <input type="submit" name="action" value="apply">
    <input type="submit" name="action" value="approve">
    <input type="submit" name="action" value="disapprove">
{% endif %}

<div class="table-wrapper">
    <table class="compact">
        <thead>
            <tr>
                {% if user.is_staff %}<th scope="col"></th>{% endif %}
                <th scope="col">date</th>
                <th scope="col">user</th>
                <th scope="col">vehicle</th>
                <th scope="col"><a href="?{{ toggle_order.vehicle }}">*</a></th>
                <th scope="col"></th>
                <th scope="col">proposed changes</th>
                <th scope="col"><a href="?{{ toggle_order.score }}">score</a></th>
                <th scope="col" colspan="4"></th>
            </tr>
        </thead>
        <tbody>
            {% for edit in edits %}
                <tr>
                    {% if user.is_staff %}<td><input type="checkbox" name="edit" value="{{ edit.id }}"></td>{% endif %}
                    <td>{{ edit.datetime }}</td>
                    <td class="link">
                        <a href="?user={{ edit.user_id }}">
                            {% if user.is_staff %}
                                {{ edit.user.username }}
                            {% else %}
                                {{ edit.user }}
                            {% endif %}
                        </a>
                    </td>
                    <td class="link"><a href="{{ edit.vehicle.get_absolute_url }}">{{ edit.vehicle }}</a></td>
                    <td>{{ edit.edit_count }}</td>
                    <td><div class="livery{% if edit.vehicle.livery_id %} livery-{{ edit.vehicle.livery_id }}{% else %}" style="background:{{ edit.vehicle.get_livery }}{% endif %}"></div></td>
                    <td>{% for key, value in edit.get_changes.items %}
                        {% if key == 'features' %}
                            {% for feature in value %}{{ feature|safe }}{% if not forloop.last %}, {% endif %}{% endfor %}
                        {% elif key == 'colours' %}
                            colours: <div class="livery" style="background:{{ edit.get_css }}"></div>
                        {% elif key == 'livery_id' %}
                            livery:
                            {% if edit.vehicle.livery %}{{ edit.vehicle.livery.name }} to {% endif %}
                            <div class="livery livery-{{ value }}"></div> {{ edit.livery.name }}
                        {% elif key == 'notes' and value == 'Duplicate' %}
                            <a href="/admin/vehicles/vehicle/?q={{ edit.vehicle.reg }}">Duplicate</a>
                        {% else %}{{ key }}: {{ value }}
                        {% endif %}
                        <br>{% endfor %}
                        {% if edit.url %}<div class="wrap">{{ edit.url|urlize }}</div>{% endif %}
                    </td>
                    <td class="score">{{ edit.score }}</td>
                    {% if user.is_staff %}
                        <td><button class="action" data-url="{{ edit.id }}/apply" style="background:#0f0">üëç apply</button></td>
                        <td><button class="action" data-url="{{ edit.id }}/approve">approve</button></td>
                        <td><button class="action" data-url="{{ edit.id }}/disapprove" style="color:#fff;background:#f00">üëé disapprove</button></td>
                    {% else %}
                        <td><button class="action" data-url="{{ edit.id }}/vote/up">üëç</button></td>
                        <td><button class="action" data-url="{{ edit.id }}/vote/down">üëé</button></td>
                    {% endif %}
                    <td class="link">{{ edit.vehicle.get_flickr_link }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if user.is_staff %}
    <input type="submit" name="action" value="apply">
    <input type="submit" name="action" value="approve">
    <input type="submit" name="action" value="disapprove">

    </form>
{% endif %}

{% if edits.has_other_pages %}
    <nav>
        <ul class="horizontal">
            {% if edits.has_previous %}
                <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}">1</a></li>
                {% if edits.previous_page_number > 1 %}
                    {% if edits.previous_page_number > 2 %}
                        <li>&hellip;</li>
                    {% endif %}
                    <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}page={{ edits.previous_page_number }}">{{ edits.previous_page_number }}</a></li>
                {% endif %}
            {% endif %}

            <li>{{ edits.number }}</li>

            {% if edits.has_next %}
                {% if edits.next_page_number < edits.paginator.num_pages %}
                    <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}page={{ edits.next_page_number }}">{{ edits.next_page_number }}</a></li>
                    <li>&hellip;</li>
                {% endif %}
                <li><a href="?{% if parameters %}{{ parameters }}&amp;{% endif %}page={{ edits.paginator.num_pages }}">{{ edits.paginator.num_pages }}</a></li>
            {% endif %}
        </ul>
    </nav>
{% endif %}

{% endblock %}

{% block ad %}{% endblock %}

{% block foot %}

<script>

(function () {
    'use strict';

    for (const button of document.querySelectorAll('button.action')) {
        let row = button.parentElement.parentElement;
        button.onclick = function(event) {
            let url = '/vehicles/edits/' + this.dataset.url;
            fetch(url, {
                method: 'POST'
            }).then(function(response) {
                if (response.ok) {
                    button.style.opacity = '.5';
                    response.text().then(text => {
                        if (text && !isNan(parseInt(text))) {
                            row.querySelector('.score').innerText = text;
                        }
                    });
                    if (url.endsWith('/up')) {
                        button.style.transition = 'transform .5s';
                        button.style.transform = 'translateY(-2em)';
                    } else if (url.endsWith('/down')) {
                        button.style.transition = 'transform .5s';
                        button.style.transform = 'translateY(2em)';
                    }
                }
            });
            return false;
        };
    }
})();
</script>

{% load static %}
<script async src="{% static 'js/edit-vehicles.js' %}"></script>

{% endblock %}
